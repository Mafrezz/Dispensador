#:import datetime datetime

<DispenserScreen@ScrollView>:
    id: dispenser
    do_scroll_x: False
    MDBoxLayout:
        orientation: "vertical"
        padding: "10dp"
        spacing: "10dp"
        size_hint_y: None
        height: self.minimum_height
        md_bg_color: 1, 1, 1, 1

        MDLabel:
            id: sel_food
            text: "Alimento: (no seleccionado)"
            font_size: "16sp"
            adaptive_height: True

        MDBoxLayout:
            spacing: "8dp"
            adaptive_height: True
            md_bg_color: 1, 1, 1, 1

            MDButton:
                id: food_btn
                on_release: app.open_food_menu(self)
                MDButtonText:
                    id: food_btn_text
                    text: "Elegir alimento"

            MDButton:
                style: "tonal"
                on_release: app.set_unit("gramos")
                MDButtonText:
                    text: "Gramos"

            MDButton:
                style: "tonal"
                on_release: app.set_unit("calorías")
                MDButtonText:
                    text: "Calorías"

        MDLabel:
            id: unit_label
            text: "Unidad actual: gramos"
            font_size: "16sp"
            adaptive_height: True

        MDTextField:
            id: amount
            hint_text: "Cantidad"
            input_filter: "float"
            text: "50"
            size_hint_y: None
            height: dp(52)

        MDTextField:
            id: hopper_idx
            hint_text: "Tolva (1-3)"
            input_filter: "int"
            text: "1"
            size_hint_y: None
            height: dp(52)

        MDLabel:
            id: conversion_label
            text: "Seleccione un alimento para ver equivalencias"
            font_size: "18sp"
            adaptive_height: True

        MDButton:
            style: "elevated"
            on_release: app.dispense()
            MDButtonText:
                text: "Dispensar"

<RootScreen@MDScreen>:
    name: "root"
    MDBoxLayout:
        orientation: "vertical"
        md_bg_color: 1, 1, 1, 1

        MDTopAppBar:
            md_bg_color: 1, 1, 1, 1
            specific_text_color: 0, 0, 0, 1
            elevation: 1
            title: "Dispensador Inteligente"
            left_action_items: [["bluetooth", lambda x: app.go("connect")]]
            right_action_items: [["history", lambda x: app.go("history")], ["clock", lambda x: app.go("schedule")], ["food", lambda x: app.go("foods")]]

        DispenserScreen:
            id: dispenser

<ConnectScreen@MDScreen>:
    name: "connect"
    MDBoxLayout:
        orientation: "vertical"
        md_bg_color: 1, 1, 1, 1

        MDTopAppBar:
            md_bg_color: 1, 1, 1, 1
            specific_text_color: 0, 0, 0, 1
            elevation: 1
            title: "Conectar por Bluetooth"
            left_action_items: [["arrow-left", lambda x: app.go_back()]]

        MDBoxLayout:
            orientation: "vertical"
            padding: "12dp"
            spacing: "8dp"
            md_bg_color: 1, 1, 1, 1

            MDButton:
                style: "elevated"
                on_release: app.refresh_paired()
                MDButtonText:
                    text: "Buscar dispositivos emparejados"

            ScrollView:
                MDList:
                    id: devices_list

<FoodsScreen@MDScreen>:
    name: "foods"
    MDBoxLayout:
        orientation: "vertical"
        md_bg_color: 1, 1, 1, 1

        MDTopAppBar:
            md_bg_color: 1, 1, 1, 1
            specific_text_color: 0, 0, 0, 1
            elevation: 1
            title: "Alimentos"
            left_action_items: [["arrow-left", lambda x: app.go_back()]]
            right_action_items: [["plus", lambda x: app.open_food_form(None)]]

        RecycleView:
            id: foods_rv
            viewclass: "MDListItem"
            RecycleBoxLayout:
                default_size: None, dp(60)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: "vertical"
                spacing: "4dp"

<ScheduleScreen@MDScreen>:
    name: "schedule"
    MDBoxLayout:
        orientation: "vertical"
        md_bg_color: 1, 1, 1, 1

        MDTopAppBar:
            md_bg_color: 1, 1, 1, 1
            specific_text_color: 0, 0, 0, 1
            elevation: 1
            title: "Programar dispensado"
            left_action_items: [["arrow-left", lambda x: app.go_back()]]
            right_action_items: [["plus", lambda x: app.open_schedule_form()]]

        RecycleView:
            id: sched_rv
            viewclass: "MDListItem"
            RecycleBoxLayout:
                default_size: None, dp(64)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: "vertical"
                spacing: "4dp"

<HistoryScreen@MDScreen>:
    name: "history"
    MDBoxLayout:
        orientation: "vertical"
        md_bg_color: 1, 1, 1, 1

        MDTopAppBar:
            md_bg_color: 1, 1, 1, 1
            specific_text_color: 0, 0, 0, 1
            elevation: 1
            title: "Historial (últimos 7 días)"
            left_action_items: [["arrow-left", lambda x: app.go_back()]]

        RecycleView:
            id: hist_rv
            viewclass: "MDListItem"
            RecycleBoxLayout:
                default_size: None, dp(64)
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: "vertical"
                spacing: "4dp"

MDScreenManager:
    id: sm
    RootScreen:
    ConnectScreen:
    FoodsScreen:
    ScheduleScreen:
    HistoryScreen: